rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // ✅ IMPROVED: Function to check if user is admin (BloomFilter safe)
    // Returns false if user document doesn't exist instead of throwing error
    function isAdmin() {
      return request.auth != null 
             && exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ✅ NEW: Safe admin check
    function isAdminSafe() {
      return request.auth != null 
             && request.auth.uid != null
             && exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ✅ NEW: Standby Engineer check
    function isStandbyEngineer() {
      return request.auth != null 
             && request.auth.uid != null
             && exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'standby_engineer';
    }


    
    // ============================================================
    // USERS COLLECTION
    // ============================================================
    match /users/{userId} {
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.uid == userId
                    && request.resource.data.keys().hasAll(['email', 'uid', 'role', 'createdAt'])
                    && (request.resource.data.role == 'admin' || request.resource.data.role == 'engineer' || request.resource.data.role == 'standby_engineer');
      
      allow read: if request.auth != null 
                  && (request.auth.uid == userId || isAdminSafe() || isStandbyEngineer());
      
      allow update: if request.auth != null 
                    && (
                      (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
                      || isAdminSafe()
                    );
      
      allow delete: if request.auth != null && isAdminSafe();
    }
    
    // ============================================================
    // EXCEL_DOCUMENTS COLLECTION - Dokumen Excel yang di-export
    // ============================================================
    match /excel_documents/{docId} {
      // ✅ User yang login bisa create document
      allow create: if request.auth != null 
                    && request.resource.data.createdBy == request.auth.token.email
                    && request.resource.data.keys().hasAll([
                      'fileName', 
                      'maintenanceName', 
                      'maintenanceTime',
                      'createdAt',
                      'createdBy',
                      'fileSize',
                      'totalPhotos',
                      'photosWithImage',
                      'photosData'
                    ])
                    && request.resource.data.photosData is list;
      
      // ✅ FIX: Use isAdminSafe() to prevent BloomFilter error
      // User hanya bisa read dokumen milik mereka sendiri, ATAU admin bisa read semua
      allow read: if request.auth != null 
                  && (resource.data.createdBy == request.auth.token.email 
                      || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      
      // ❌ Documents are immutable - tidak bisa di-update setelah dibuat
      allow update: if false;
      
      // ✅ FIX: Use isAdminSafe() to prevent BloomFilter error
      allow delete: if request.auth != null 
                    && (resource.data.createdBy == request.auth.token.email 
                        || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }
    
    // ============================================================
    // PDF_DOCUMENTS COLLECTION - Dokumen PDF yang di-export
    // ============================================================
    match /pdf_documents/{docId} {
      // ✅ User yang login bisa create document
      allow create: if request.auth != null 
                    && request.resource.data.createdBy == request.auth.token.email
                    && request.resource.data.keys().hasAll([
                      'fileName', 
                      'maintenanceName', 
                      'maintenanceTime',
                      'createdAt',
                      'createdBy',
                      'fileSize',
                      'totalPhotos',
                      'photosWithImage',
                      'photosData'
                    ])
                    && request.resource.data.photosData is list;
      
      // ✅ FIX: Inline admin check to prevent BloomFilter error
      allow read: if request.auth != null 
                  && (resource.data.createdBy == request.auth.token.email 
                      || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      
      // ❌ Documents are immutable - tidak bisa di-update setelah dibuat
      allow update: if false;
      
      // ✅ FIX: Inline admin check to prevent BloomFilter error
      allow delete: if request.auth != null 
                    && (resource.data.createdBy == request.auth.token.email 
                        || (exists(/databases/$(database)/documents/users/$(request.auth.uid))
                            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }
    
    // ============================================================
    // FILES COLLECTION - File management (Sharded in Firestore)
    // ============================================================
    match /files/{fileId} {
      // ✅ Admin bisa upload/create file metadata
      allow create: if request.auth != null 
                    && isAdminSafe()
                    && request.resource.data.keys().hasAll([
                      'fileName',
                      'fileSize',
                      'fileType',
                      'category',
                      'uploadedBy',
                      'uploadedByEmail',
                      'uploadedAt'
                    ])
                    && request.resource.data.uploadedBy == request.auth.uid
                    && request.resource.data.uploadedByEmail == request.auth.token.email;
      
      // ✅ Semua authenticated user bisa read files (admin & engineer)
      allow read: if request.auth != null;
      
      // ✅ Admin bisa update status (untuk upload completion)
      allow update: if request.auth != null 
                    && isAdminSafe()
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
      
      // ✅ Admin bisa delete file
      allow delete: if request.auth != null && isAdminSafe();

      // ============================================================
      // CHUNKS SUB-COLLECTION - Potongan data file
      // ============================================================
      match /chunks/{chunkId} {
        // ✅ Admin bisa create chunks
        allow create: if request.auth != null && isAdminSafe();
        
        // ✅ Semua user bisa read chunks (untuk download)
        allow read: if request.auth != null;
        
        // ✅ Admin bisa delete chunks
        allow delete: if request.auth != null && isAdminSafe();
      }
    }

    // ============================================================
    // CORRECTIVE MAINTENANCE REPORTS
    // ============================================================
    match /corrective_reports/{reportId} {
      // ✅ Create: Only Standby Engineer
      allow create: if request.auth != null && isStandbyEngineer();
      
      // ✅ Read: All authenticated users (Admin, Engineer, Standby)
      allow read: if request.auth != null;
      
      // ✅ Delete: Admin or Owner (Standby Engineer)
      allow delete: if request.auth != null 
                    && (isAdminSafe() || (isStandbyEngineer() && resource.data.reportedBy == request.auth.uid));
    }
    
    // ============================================================
    // REPORTS COLLECTION (Optional - jika masih dipakai)
    // ============================================================
    match /reports/{reportId} {
      // ✅ User yang login bisa create report
      allow create: if request.auth != null 
                    && request.resource.data.createdBy == request.auth.token.email
                    && request.resource.data.keys().hasAll([
                      'maintenanceName', 
                      'maintenanceTime', 
                      'cards', 
                      'createdBy', 
                      'createdAt'
                    ]);
      
      // ✅ User hanya bisa read report mereka sendiri
      allow read: if request.auth != null 
                  && resource.data.createdBy == request.auth.token.email;
      
      // ✅ User hanya bisa update report mereka sendiri
      allow update: if request.auth != null 
                    && resource.data.createdBy == request.auth.token.email;
      
      // ✅ User hanya bisa delete report mereka sendiri
      allow delete: if request.auth != null 
                    && resource.data.createdBy == request.auth.token.email;
    }
    
    // ============================================================
    // DEFAULT - Block semua akses ke collection lain
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
